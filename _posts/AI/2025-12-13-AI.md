---
title: 自建AI服务器
author: Harpyja
date: 2025-12-19
category: Jekyll
tags: [autoglm,ai,vllm,rocm]
layout: post
---

本文尝试使用[AutoGLM][1]官方推荐的vllm部署方式进行部署

> ##### 配置
> CPU: AMD AI MAX+ 395
> 
> MEM: 128G
> 
> GPU: 8060S
> 
> 环境: LM-Studio, Ubuntu24.04, Rocm7.11, rocm/vllm:latest

> ##### 注意
> 目前rocm在gfx1151上存在很大问题 不建议使用wsl运行使用rocm，具体问题可参考灵核大佬文章：
> 
> 星空灵核：[https://zhuanlan.zhihu.com/p/1965829719074243666][2]
>
> 此处使用rocm官方vllm docker镜像部署在ubuntu24.04上
> 
{: .block-warning }

#### 安装Ubuntu22.04 AMDGpu驱动
这里24.04使用22.04驱动是可以正常显示的
[https://repo.radeon.com/amdgpu-install/latest/ubuntu/jammy/amdgpu-install_7.1.1.70101-1_all.deb][3]
```shell
curl -O https://repo.radeon.com/amdgpu-install/latest/ubuntu/jammy/amdgpu-install_7.1.1.70101-1_all.deb
sudo apt install ./amdgpu-install_7.1.1.70101-1_all.deb
```

#### 使用docker下载镜像
```shell
docker pull rocm/vllm:latest
```

#### 启动docker
这里未使用一次性docker容器来进行测试，方便模型缓存后续使用
```shell
sudo docker run --it --name rocmvllm \ #设置容器名称
--device=/dev/kfd --device=/dev/dri \ ##!!这里需要把gpu设备挂载到docker容器里，否则容器无法使用gpu运行大模型
--group-add video \ ## 此参数为容器中用户添加至video用户组以访问gpu
--ipc=host \ ## 用于监听访问接口
--port=8000:8000 \ ## 用于端口转发 前一个端口是容器内端口，后一个为转发后的宿主机端口
--privileged \ ## 用于容器内权限获取
rocm/vllm:latest \ ##使用镜像名称
bash \ ## 启动容器后进入到bash
```

于容器中执行rocminfo来查看是否能正确识别gfx1151架构显卡，如无法识别则说明环境存在问题
```shell
rocminfo
```

#### 运行官方命令
```shell
HF_ENDPOINT=https://hf-mirror.com  python3 -m vllm.entrypoints.openai.api_server \
 --served-model-name autoglm-phone-9b \
 --allowed-local-media-path /   \
 --mm-encoder-tp-mode data \
 --mm_processor_cache_type shm \
 --mm_processor_kwargs "{\"max_pixels\":5000000}" \
 --max-model-len 25480  \
 --chat-template-content-format string \
 --limit-mm-per-prompt "{\"image\":10}" \
 --model zai-org/AutoGLM-Phone-9B \
 --port 8000
```
> ##### 注意
> 这里不要指定gguf量化版模型，vllm无法使用。
> PPS：由于huggingface.co国内访问存在问题 这里使用hf-mirror.com镜像站来代替访问 速度还是挺快的
>
全部运行完就可以使用python脚本访问接口进行测试了

[1]: https://github.com/zai-org/Open-AutoGLM
[2]: https://zhuanlan.zhihu.com/p/1965829719074243666
[3]: https://repo.radeon.com/amdgpu-install/latest/ubuntu/jammy/amdgpu-install_7.1.1.70101-1_all.deb